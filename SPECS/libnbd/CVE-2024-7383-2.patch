From 7ece17bfb16d437975ac40d63b0f20162601d3bf Mon Sep 17 00:00:00 2001
From: Brian Fjeldstad <bfjelds@microsoft.com>
Date: Mon, 19 Aug 2024 22:01:17 +0000
Subject: [PATCH 2/3] port patch #2

---
 lib/crypto.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/lib/crypto.c b/lib/crypto.c
index 964a871..97884b8 100644
--- a/lib/crypto.c
+++ b/lib/crypto.c
@@ -514,9 +514,6 @@ set_up_certificate_credentials (struct nbd_handle *h,
   return NULL;
 
  found_certificates:
-  if (h->hostname && h->tls_verify_peer)
-    gnutls_session_set_verify_cert (session, h->hostname, 0);
-
   err = gnutls_credentials_set (session, GNUTLS_CRD_CERTIFICATE, ret);
   if (err < 0) {
     set_error (0, "gnutls_credentials_set: %s", gnutls_strerror (err));
@@ -626,6 +623,9 @@ nbd_internal_crypto_create_session (struct nbd_handle *h,
       gnutls_deinit (session);
       return NULL;
     }
+
+    if (h->hostname && h->tls_verify_peer)
+      gnutls_session_set_verify_cert (session, h->hostname, 0);
   }
 
   /* Wrap the underlying socket with GnuTLS. */
-- 
2.34.1

